<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>RunBuddy Coach</title>
		<style>
			:root {
				color-scheme: light dark;
				font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
			}

			body {
				margin: 0;
				min-height: 100vh;
				display: flex;
				justify-content: center;
				background: radial-gradient(circle at top, #0f172a 0%, #020617 55%, #000 100%);
				color: #f8fafc;
			}

			.layout {
				width: min(1080px, 100%);
				padding: clamp(1.25rem, 4vw, 3rem);
				display: flex;
				flex-direction: column;
				gap: clamp(1.5rem, 3vw, 2.5rem);
			}

			header {
				text-align: center;
				display: grid;
				gap: 0.75rem;
			}

			h1 {
				margin: 0;
				font-size: clamp(2rem, 5vw, 3.25rem);
				letter-spacing: 0.02em;
			}

			header p {
				margin: 0 auto;
				max-width: 48rem;
				color: rgba(241, 245, 249, 0.72);
				line-height: 1.6;
			}

			main {
				display: grid;
				gap: clamp(1.25rem, 3vw, 2rem);
			}

			.panel {
				border-radius: clamp(1rem, 2vw, 1.5rem);
				background: rgba(15, 23, 42, 0.72);
				border: 1px solid rgba(148, 163, 184, 0.22);
				box-shadow: 0 24px 60px rgba(15, 23, 42, 0.5);
				backdrop-filter: blur(14px);
				padding: clamp(1.25rem, 3vw, 2.25rem);
				display: flex;
				flex-direction: column;
				gap: clamp(1rem, 2vw, 1.75rem);
			}

			.panel--chat {
				min-height: clamp(520px, 75vh, 760px);
			}

			.panel h2 {
				margin: 0;
				font-size: clamp(1.25rem, 3vw, 1.6rem);
			}

			.panel p {
				margin: 0;
				color: rgba(226, 232, 240, 0.75);
				line-height: 1.6;
			}

			.chat-shell {
				display: flex;
				flex-direction: column;
				gap: clamp(0.9rem, 2vw, 1.5rem);
				height: 100%;
			}

			.chat-controls {
				display: flex;
				flex-wrap: wrap;
				gap: 0.85rem;
				align-items: flex-end;
				justify-content: space-between;
				row-gap: 0.6rem;
			}

			.chat-controls__email {
				flex: 1 1 320px;
				display: grid;
				gap: 0.4rem;
				font-weight: 600;
				color: rgba(94, 234, 212, 0.92);
				text-transform: uppercase;
				letter-spacing: 0.08em;
				font-size: 0.78rem;
				position: relative;
			}

			.chat-controls__input {
				display: flex;
				align-items: center;
			}

			.chat-controls__input input {
				flex: 1;
				border-top-right-radius: 0;
				border-bottom-right-radius: 0;
				margin: 0;
			}

			.chat-controls__actions {
				display: flex;
				align-items: stretch;
			}

			.chat-controls__actions button {
				border-top-left-radius: 0;
				border-bottom-left-radius: 0;
				min-height: 52px;
			}

			input {
				font: inherit;
				padding: 0.85rem 1rem;
				border-radius: 0.9rem;
				border: 1px solid rgba(148, 163, 184, 0.25);
				background: rgba(2, 6, 23, 0.6);
				color: inherit;
				transition: border-color 140ms ease, box-shadow 140ms ease;
				width: 100%;
			}

			input:focus {
				border-color: rgba(56, 189, 248, 0.8);
				outline: none;
				box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.25);
			}

			.chat-window {
				flex: 1;
				display: flex;
				flex-direction: column;
				overflow: hidden;
				border-radius: 1.2rem;
				border: 1px solid rgba(148, 163, 184, 0.2);
				background: rgba(9, 16, 28, 0.78);
				box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
			}

			.chat-transcript {
				flex: 1;
				position: relative;
				overflow-y: auto;
				padding: clamp(1rem, 2vw, 1.4rem);
				border-bottom: 1px solid rgba(148, 163, 184, 0.18);
			}

			#messages {
				list-style: none;
				margin: 0;
				padding: 0;
				display: flex;
				flex-direction: column;
				gap: 0.85rem;
			}

			.message {
				padding: 0.95rem 1.15rem;
				border-radius: 1rem;
				background: rgba(15, 23, 42, 0.75);
				border: 1px solid rgba(148, 163, 184, 0.22);
				box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.03);
				white-space: pre-wrap;
			}

			.message.user {
				border-color: rgba(56, 189, 248, 0.32);
				background: rgba(14, 116, 144, 0.45);
				align-self: flex-end;
			}

			.message strong {
				display: block;
				margin-bottom: 0.35rem;
				font-size: 0.75rem;
				letter-spacing: 0.12em;
				text-transform: uppercase;
				color: rgba(148, 163, 184, 0.7);
			}

			.chat-composer {
				display: flex;
				align-items: flex-end;
				gap: 0.85rem;
				padding: clamp(0.85rem, 2vw, 1.1rem);
				backdrop-filter: blur(8px);
			}

			.chat-composer textarea {
				flex: 1;
				font: inherit;
				color: inherit;
				background: transparent;
				border: none;
				resize: none;
				min-height: 3rem;
				max-height: 12rem;
				line-height: 1.6;
				padding: 0;
			}

			.chat-composer textarea:focus {
				outline: none;
			}

			button {
				font: inherit;
				font-weight: 600;
				border: none;
				border-radius: 999px;
				padding: 0.9rem 1.75rem;
				background: linear-gradient(135deg, #0ea5e9, #22d3ee);
				color: #0b1120;
				cursor: pointer;
				transition: transform 140ms ease, box-shadow 140ms ease;
			}

			button:hover {
				transform: translateY(-1px);
				box-shadow: 0 12px 30px rgba(14, 165, 233, 0.35);
			}

			button:active {
				transform: translateY(0);
				box-shadow: 0 8px 20px rgba(14, 165, 233, 0.3);
			}

			button[disabled] {
				opacity: 0.7;
				cursor: not-allowed;
				box-shadow: none;
			}

			button.secondary {
				background: rgba(148, 163, 184, 0.18);
				color: rgba(241, 245, 249, 0.85);
			}

			.chat-send {
				display: inline-flex;
				align-items: center;
				gap: 0.35rem;
				padding-inline: 1.6rem;
				min-height: 3rem;
			}

			.status {
				font-size: 0.85rem;
				color: rgba(148, 163, 184, 0.8);
				min-height: 1.4rem;
			}

			@media (max-width: 720px) {
				body {
					background: linear-gradient(180deg, #0f172a, #020617 55%);
				}

				.panel {
					padding: 1.1rem;
				}

				button {
					padding-inline: 1.4rem;
				}
			}
		</style>
	</head>
	<body>
		<div class="layout">
			<header>
				<h1>RunBuddy Coach</h1>
				<p>
					Chat with your personalized running coach. Every conversation flows through a Durable Object that remembers your email, goals, and logged workouts—so plans evolve as you improve.
				</p>
			</header>
			<main>
				<section class="panel panel--chat">
					<div>
						<h2>Start a Conversation</h2>
						<p>
							Enter the email you want RunBuddy to associate with your training profile. The conversation area retains your history, and the composer at the bottom works like ChatGPT—press Enter to send or Shift+Enter for a new line.
						</p>
					</div>
					<div class="chat-shell">
						<div class="chat-controls">
							<label class="chat-controls__email" for="runner-email">
								<span>Runner Email</span>
								<div class="chat-controls__input">
									<input id="runner-email" name="email" type="email" required placeholder="athlete@example.com" autocomplete="email" />
									<div class="chat-controls__actions">
										<button type="button" class="secondary" id="clear-history">Clear History</button>
									</div>
								</div>
							</label>
						</div>
						<div class="chat-window">
							<div class="chat-transcript" aria-live="polite" aria-label="Conversation transcript">
								<ul id="messages"></ul>
							</div>
							<form id="chat-form" class="chat-composer" novalidate>
								<textarea id="runner-message" name="message" required placeholder="Type a message for RunBuddy..." aria-label="Message to RunBuddy" spellcheck="true"></textarea>
								<button type="submit" class="chat-send">Send</button>
							</form>
						</div>
						<p class="status" id="status" role="status"></p>
					</div>
				</section>
				<section class="panel" id="tips">
					<h2>Helpful Prompts</h2>
					<p>RunBuddy has access to tools that update your profile, log workouts, and adjust plans. Try:</p>
					<ul>
						<li>“Set my profile: I'm training for the NYC marathon on November 3rd and can run 5 days a week.”</li>
						<li>“Log today's 10km tempo run at moderate effort so we can track progress.”</li>
						<li>“What should the next four weeks look like if I'm targeting a sub-1:45 half?”</li>
					</ul>
				</section>
			</main>
		</div>
		<script>
			const messagesEl = document.getElementById("messages");
			const form = document.getElementById("chat-form");
			const emailInput = document.getElementById("runner-email");
			const promptInput = document.getElementById("runner-message");
			const statusEl = document.getElementById("status");
			const clearBtn = document.getElementById("clear-history");
			const sendButton = form.querySelector('button[type="submit"]');
			const conversation = [];
			let seededEmailContext = false;

			const uuid = () => (crypto.randomUUID ? crypto.randomUUID() : `id-${Date.now()}-${Math.random().toString(16).slice(2)}`);

			const autoGrowComposer = () => {
				promptInput.style.height = "auto";
				const next = Math.min(promptInput.scrollHeight, 220);
				promptInput.style.height = `${Math.max(next, 52)}px`;
			};

			const getTranscriptEl = () => messagesEl.parentElement;

			const renderMessage = (role, text) => {
				const li = document.createElement("li");
				li.className = `message ${role}`;
				const strong = document.createElement("strong");
				strong.textContent = role === "user" ? "You" : "RunBuddy";
				li.appendChild(strong);
				const span = document.createElement("span");
				span.textContent = text;
				li.appendChild(span);
				messagesEl.appendChild(li);
				const transcript = getTranscriptEl();
				transcript.scrollTop = transcript.scrollHeight;
				return span;
			};

			const setUiDisabled = (isDisabled) => {
				[promptInput, sendButton, emailInput, clearBtn].forEach((el) => {
					if (!el) return;
					el.disabled = isDisabled;
				});
			};

			const pushUserMessage = (text) => {
				const message = {
					id: uuid(),
					role: "user",
					content: text,
					createdAt: new Date().toISOString()
				};
				conversation.push(message);
				return message;
			};

			const pushAssistantMessage = (text) => {
				const message = {
					id: uuid(),
					role: "assistant",
					content: text,
					createdAt: new Date().toISOString()
				};
				conversation.push(message);
				return message;
			};

			const resetStatus = () => {
				statusEl.textContent = "";
			};

			const showStatus = (text) => {
				statusEl.textContent = text;
			};

			const parseSSE = async (response, onEvent) => {
				const reader = response.body.getReader();
				const decoder = new TextDecoder();
				let buffer = "";
				while (true) {
					const { value, done } = await reader.read();
					if (done) break;
					buffer += decoder.decode(value, { stream: true });
					const segments = buffer.split("\n\n");
					buffer = segments.pop() ?? "";
					for (const segment of segments) {
						const line = segment.trim();
						if (!line.startsWith("data:")) continue;
						const payload = line.slice(5).trim();
						if (!payload || payload === "[DONE]") continue;
						try {
							const event = JSON.parse(payload);
							onEvent(event);
						} catch (error) {
							console.error("Failed to parse event", payload, error);
						}
					}
				}
			};

			const sendMessage = async (email, text) => {
				if (!seededEmailContext) {
					conversation.push({
						id: uuid(),
						role: "system",
						content: `The runner's email address is ${email}. Whenever you use a tool, include this email so the Durable Object keeps state in sync. If you did not receive a user profile yet, use set_runner_profile to create one.`,
						createdAt: new Date().toISOString()
					});
					seededEmailContext = true;
				}

				const userMessage = pushUserMessage(text);
				const userBubble = renderMessage("user", text);
				userBubble.parentElement.dataset.id = userMessage.id;

				showStatus("Contacting RunBuddy...");
				setUiDisabled(true);
				let assistantSpan = null;
				let assistantText = "";
				let assistantMessage = null;

				try {
					const response = await fetch("/chat", {
						method: "POST",
						headers: {
							"Content-Type": "application/json"
						},
						body: JSON.stringify({ email, messages: conversation })
					});

					if (!response.ok || !response.body) {
						throw new Error(`RunBuddy returned ${response.status}`);
					}

					assistantSpan = renderMessage("assistant", "");

					await parseSSE(response, (event) => {
						console.debug("RunBuddy event", event);

						if (event.response !== undefined && event.response !== null) {
							assistantText += event.response;
							assistantSpan.textContent = assistantText;
						}

						if (event.type === "text-delta") {
							assistantText += event.delta;
							assistantSpan.textContent = assistantText;
						}

						if (event.type === "tool-call") {
							showStatus(`RunBuddy is using ${event.toolName}...`);
						}

						if (event.type === "tool-output-available") {
							showStatus(`Tool ${event.toolName} completed.`);
							if (event.output && typeof event.output === "string") {
								assistantText += `\n🔧 ${event.toolName}: ${event.output}`;
								assistantSpan.textContent = assistantText.trim();
							}
						}

						if (event.type === "error") {
							assistantSpan.textContent = `⚠️ ${event.errorText ?? "Unexpected error from upstream."}`;
						}
					});

					assistantText = assistantText.trim();
					if (!assistantText) {
						assistantText = "RunBuddy finished without returning text.";
						assistantSpan.textContent = assistantText;
					}
					assistantMessage = pushAssistantMessage(assistantText);
					assistantSpan.parentElement.dataset.id = assistantMessage.id;
					showStatus(`RunBuddy replied at ${new Date().toLocaleTimeString()}`);
				} catch (error) {
					console.error(error);
					showStatus("RunBuddy could not process your request. Check the console for details.");
					if (assistantSpan) {
						assistantSpan.textContent = `⚠️ ${error.message}`;
					}
				} finally {
					setUiDisabled(false);
					promptInput.value = "";
					autoGrowComposer();
					promptInput.focus();
				}
			};

			form.addEventListener("submit", (event) => {
				event.preventDefault();
				const email = emailInput.value.trim();
				const text = promptInput.value.trim();
				resetStatus();
				if (!email) {
					showStatus("Please provide an email so RunBuddy can store your profile.");
					emailInput.focus();
					return;
				}
				if (!text) {
					showStatus("Enter something you'd like to ask RunBuddy.");
					promptInput.focus();
					return;
				}
				sendMessage(email, text);
			});

			promptInput.addEventListener("input", autoGrowComposer);
			promptInput.addEventListener("keydown", (event) => {
				if (event.key === "Enter" && !event.shiftKey) {
					event.preventDefault();
					form.requestSubmit();
				}
			});

			clearBtn.addEventListener("click", () => {
				conversation.length = 0;
				messagesEl.innerHTML = "";
				seededEmailContext = false;
				resetStatus();
				showStatus("Conversation history cleared. RunBuddy will treat the next message as a new session.");
				promptInput.focus();
			});

			window.addEventListener("load", () => {
				promptInput.placeholder = "Type a message for RunBuddy...";
				seededEmailContext = false;
				statusEl.textContent = "";
				autoGrowComposer();
			});
		</script>
	</body>
</html>
